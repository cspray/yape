#!/usr/bin/env php
<?php declare(strict_types=1);

namespace Cspray\Yape;

$cwd = getcwd();

require_once $cwd . '/vendor/autoload.php';

echo 'Where would you like to create your new enum? (src): ';
$dir = trim(fgets(STDIN));
if (empty($dir)) {
    $dir = 'src';
}
$dir = $cwd . DIRECTORY_SEPARATOR . rtrim($dir, DIRECTORY_SEPARATOR);

if (!is_dir($dir) || !is_writable($dir)) {
    echo 'The directory to create the enum must be writeable', PHP_EOL;
    exit(255);
}

try {
    $factory = new EnumDefinitionFactory();
    $definition = $factory->fromCliArgs($argv);
    $enumFile = $dir . DIRECTORY_SEPARATOR . $definition->getEnumName() . '.php';
    if (file_exists($enumFile)) {
        echo 'A file already exists at ' . $enumFile . '. Do you want to overwrite it? (y/N) ';
        $overwrite = trim(fgets(STDIN));
        if (empty($overwrite) || strtolower($overwrite) === 'n') {
            echo 'Skipping enum generation due to existing file', PHP_EOL;
            exit(0);
        }

    }

    $code = (new EnumCodeGenerator(new EnumDefinitionValidator()))->generateEnumCode($definition);

    $written = file_put_contents($enumFile, $code);
    if ($written === false) {
        echo sprintf('There was an unexpected error writing the enum code to the specified file, "%s"', $enumFile), PHP_EOL;
        exit(255);
    } else {
        echo 'Your enum was successfully created!', PHP_EOL;
        exit(0);
    }
} catch (\InvalidArgumentException $argumentException) {
    echo "There was an error creating your enum. The exact problems are:", PHP_EOL;
    echo "\t- ", $argumentException->getMessage(), PHP_EOL;
    exit(255);
} catch (EnumValidationException $enumValidationException) {
    echo "There was an error creating your enum. The exact problems are:", PHP_EOL;
    foreach ($enumValidationException->getValidationResults()->getErrorMessages() as $errorMessage) {
        echo "\t- ", $errorMessage, PHP_EOL;
    }
    exit(255);
}

